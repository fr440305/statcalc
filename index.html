<!doctype html>

<html>
<head>
	<meta charset='utf8'>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
table, tr, td {
	border: 1px solid black;
}
textarea {
	font-size: 18px;
	width: 90%;
	height: 10em;
	margin: auto;
}

#btn_calculate {
	width: 90%;
	margin: auto;
}

#result {
	display: none;
}
	</style>
</head>
<body>
	<textarea placeholder='23 34 12 33 45' id='data'></textarea>
	<input type='button' value='Go' id='btn_calculate'></input>
	<div id='result'>
		<table>
			<tr><td>Sorted dataset</td><td>{{#sorted}}{{.}} {{/sorted}}</td></tr>
			<tr><td>Mean</td><td>{{mean}}</td></tr>
			<tr><td>Median</td><td>{{median}}</td></tr>
			<tr><td>Modes</td><td>{{#modes}}{{.}}, appeared {{maxfreq}} times.{{/modes}}{{^modes}}N/A{{/modes}}</td></tr>
			<tr><td>Minimum and Maximun</td><td>min = {{min}}, max = {{max}}</td></tr>
			<tr><td>Range</td><td>{{max}} - {{min}} = <b>{{range}}</b></td></tr>
			<tr><td>Quartiles</td><td>q1 = <b>{{q1}}</b>, q2 = <b>{{q2}}</b>, q3 = <b>{{q3}}</b></td></tr>

		</table>
	</div>

<!--
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script src="https://unpkg.com/mustache@latest"></script>
<script>

TMPL = result.innerHTML;

function getArray(text) {
	arr = [];
	//toks = text.split('\n').join(' ').split(' ');
	toks = text.split(/(\s+)/).join(',').split(',');
	for (i = 0; i < toks.length; i++) {
		x = parseFloat(toks[i]);
		if (x) {
			arr.push(parseFloat(toks[i]));
		}
	}
	// The implementation of `Array.sort()` might have issue on Firefox.
	for (var i = 0; i < arr.length; i++) {
		for (var j = i+1; j < arr.length; j++) {
			if (arr[j] < arr[i]) {
				var t = arr[i];
				arr[i] = arr[j];
				arr[j] = t;
			}
		}
	}
	console.log(arr);
	return arr;
}

function getMedian(arr) {
	// Assume that the array is sorted.
	if (arr.length % 2 !== 0) {
		median = arr[(arr.length-1)/2];
	} else {
		median = (arr[arr.length/2] + arr[arr.length/2-1]) / 2;
	}
	return median;
}

function getCharacteristicValues(arr) {
	console.log(arr.length);
	if (arr.length === 0) {
		return ({"err": "Empty dataset is not valid."});
	}
	// Find mean.
	var sum = 0;
	for (var i = 0; i < arr.length; i++) {
		sum += arr[i];
	}
	var mean = sum / arr.length;
	// Find median.
	var median = getMedian(arr);
	// Find modes.
	var dictValFreq = {};
	var dictFreqVals = {};
	var maxFreq = 1;
	var modes = [];
	for (var i = 0; i < arr.length; i++) {
		if (dictValFreq[arr[i]] === undefined) {
			dictValFreq[arr[i]] = 1;
		} else {
			dictValFreq[arr[i]] ++;
		}
	}
	for (var val in dictValFreq) {
		var freq = dictValFreq[val];
		if (freq > maxFreq) {
			maxFreq = freq;
		}
		if (dictFreqVals[freq] === undefined) {
			dictFreqVals[freq] = [val];
		} else {
			dictFreqVals[freq].push(val);
		}
	}
	if (maxFreq >= 2) {
		modes = dictFreqVals[maxFreq];
	}
	// Find the Variance of Population.
	var variance = 0;
	for (var i = 0; i < arr.length; i++) {
		variance += (arr[i] - mean) * (arr[i] - mean);
	}
	variance /= arr.length;
	// Find quartiles: q1, q2, q3.
	// If arr.length odd, then GET RID OF THE MEDIAN and split the array into two halves.
	var q2 = median;
	if (arr.length % 2 === 0) { // even
		var ll = arr.slice(0, arr.length/2);
		var rr = arr.slice(arr.length/2 + 1, arr.length);
	} else {
		var ll = arr.slice(0, (arr.length-1)/2);
		var rr = arr.slice((arr.length-1)/2 + 1, arr.length);
	}
	var q1 = getMedian(ll);
	var q3 = getMedian(rr);

	// Finally...
	return ({
		"sorted": arr,
		"length": arr.length,
		"sum": sum,
		"mean": mean,
		"median": median,
		"modes": modes,
		"hasmode": (modes.length > 0),
		"maxfreq": maxFreq,
		"freqtable": dictValFreq,
		"variance": variance,
		"stddev": Math.sqrt(variance),
		"min": arr[0],
		"max": arr[arr.length-1],
		"range": arr[arr.length-1] - arr[0],
		//"quartiles": [arr[0], q1, q2, q3, arr[arr.length-1]]
		"q1": q1,
		"q2": q2,
		"q3": q3
	});
}

function renderResult(tmpl, res) {
	var rendered = Mustache.render(tmpl, res);
	console.log(rendered);
	//result.innerText = JSON.stringify(res);
	result.innerHTML = rendered;
}

btn_calculate.onclick = function(){
	var res = getCharacteristicValues(getArray(data.value));
	console.log(res);
	if (res.err && res.err.length > 0) {
		result.innerText = res.err;
	} else {
		renderResult(TMPL, res);
	}
	result.style.display = 'block';
}

</script>
</body>
</html>
